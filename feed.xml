<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Dr. Alexander Lenk</title>
    <description>Cloud Computing, Smart Data Technology and Standardization, Big Data, Disaster Recovery, Distributed Systems, Digitalization, Tech</description>
    <link>http://www.alenk.de//</link>
    <atom:link href="http://www.alenk.de//feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Thu, 16 Feb 2017 21:55:45 +0100</pubDate>
    <lastBuildDate>Thu, 16 Feb 2017 21:55:45 +0100</lastBuildDate>
    <generator>Jekyll v3.3.1</generator>
    
      <item>
        <title>Adding Airplay to a Bose SoundDock Portable</title>
        <description>&lt;p&gt;After having my old Bose SoundDock with an old iPhone 30pin plug standing around useless, I thought it is time to give this old device a new life and add Airplay to it.&lt;/p&gt;

&lt;p&gt;After some research and dissembling the box I soon figured that the best place to put the additional hardware is the battery pack, I’ve actually never needed before. I use it in my living room and therefore this battery pack is just dead weight to me but the housing is a perfect place to fit a headless Raspberry Pi A+ in. So in the following I’m describing what you need to turn the old Bose SoundDock Portable into an Airplay device.&lt;/p&gt;

&lt;p&gt;Requirements:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Raspberry Pi A+ with 2 GB micro SD card&lt;/li&gt;
  &lt;li&gt;Step-Down converter (20V to 5V/USB)&lt;/li&gt;
  &lt;li&gt;HifiBerry DAC+ Standard Phone&lt;/li&gt;
  &lt;li&gt;Nano Wifi Stick&lt;/li&gt;
  &lt;li&gt;3,5mm male to male aux cable (20cm)&lt;/li&gt;
  &lt;li&gt;Micro USB cable (10cm)&lt;/li&gt;
  &lt;li&gt;Soldering iron, solder wire, desoldering wick, some wires&lt;/li&gt;
  &lt;li&gt;Hot glue gun&lt;/li&gt;
  &lt;li&gt;Tools&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;dissembling-the-battery-pack&quot;&gt;Dissembling the battery pack&lt;/h1&gt;

&lt;p&gt;The battery pack comes off easily by turning the lock on the back of the box. Under the sticker saying “Do not open might explode” there are 4 Torx screws that allow you to open the battery pack. &lt;code&gt;Disclaimer: Before opening the pack be sure that you know what you are doing and be careful. The warnings are not without any reason on there and you could harm you, the box, or others.&lt;/code&gt; Having that said, after unscrewing the lid, the battery pack can carefully be removed from the casing (it is glued) and you can use the soldering iron to remove the plug that goes to the box from the board. Again be careful and you might wanna cut the wires coming from the battery first.&lt;/p&gt;

&lt;p&gt;This plug you can afterwards glue in the lid of the housing, solder to the most left and most right pin a wire, and use more glue to isolate all the pins (these pins are in the end really close to your Raspi and you don’t want to apply these 20V of the box directly to some components of it.&lt;/p&gt;

&lt;h1 id=&quot;preparing-the-raspi&quot;&gt;Preparing the Raspi&lt;/h1&gt;

&lt;p&gt;Since we’re powering the Raspi directly from the box and don’t want this box and the Raspi running all the time we want a very robust installation that has no problems with power outages. This is done by having a read only filesystem on the card. For the AirPlay client we use Shairport. Since the Raspi A+ has no network and only one USB port I highly recommend to use a USB hub or a model B for the installation.&lt;/p&gt;

&lt;p&gt;The general idea of the setup is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Install Raspbian, remove unnecessary software (xserver, hwclock, swap, etc), Wifi stick, and connect it to the local WLAN&lt;/li&gt;
  &lt;li&gt;Install and Tweak Shairport Shairport&lt;/li&gt;
  &lt;li&gt;Install HifiBerry&lt;/li&gt;
  &lt;li&gt;Make the disk read only&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;install-raspbian&quot;&gt;Install Raspbian&lt;/h2&gt;

&lt;p&gt;There are several good tutorials on the net how to install Raspbian, so I’m not going into any details here. Also this tutorial is based on the very good tutorials for installing Shairport of &lt;a href=&quot;http://www.welzels.de/blog/2014/12/raspberry-pi-als-airplay-client-update/&quot;&gt;Wel!s Blog&lt;/a&gt; and creating a read only Raspbian installation of &lt;a href=&quot;http://k3a.me/how-to-make-raspberrypi-truly-read-only-reliable-and-trouble-free/&quot;&gt;K3A&lt;/a&gt;. I just assume you have a up to date Raspbian installation and used &lt;code&gt;raspi-conf&lt;/code&gt; to expand your partition to the size of the disk.&lt;/p&gt;

&lt;p&gt;First of all you want to get rid of all the unnecessary things [&lt;a href=&quot;http://www.welzels.de/blog/2014/12/raspberry-pi-als-airplay-client-update/&quot;&gt;1&lt;/a&gt;][&lt;a href=&quot;http://k3a.me/how-to-make-raspberrypi-truly-read-only-reliable-and-trouble-free/&quot;&gt;2&lt;/a&gt;]:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo apt-get remove x11-common x11-utils x11-xkb-utils libx11-6 lxde-common 
sudo apt-get remove wolfram-engine triggerhappy cron anacron logrotate 
sudo apt-get remove dphys-swapfile xserver-common lightdm fake-hwclock
sudo apt-get autoremove
sudo dpkg --list | grep &quot;^rc&quot; | cut -d &quot; &quot; -f 3 | xargs sudo dpkg --purge
sudo apt-get autoclean
sudo apt-get install busybox-syslogd ntpdate
sudo dpkg --purge rsyslog
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The next step is to disable the filesystem check (since you just uninstalled the hwclock), edit &lt;code&gt;/boot/cmdline.txt&lt;/code&gt; and add to the end of the line [&lt;a href=&quot;http://k3a.me/how-to-make-raspberrypi-truly-read-only-reliable-and-trouble-free/&quot;&gt;2&lt;/a&gt;]:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;fastboot noswap
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;install-and-tweak-shairport&quot;&gt;Install and Tweak Shairport&lt;/h2&gt;

&lt;p&gt;Installing Shairport is pretty straight forward [&lt;a href=&quot;http://www.welzels.de/blog/2014/12/raspberry-pi-als-airplay-client-update/&quot;&gt;1&lt;/a&gt;]:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;git clone https://github.com/abrasive/shairport.git
sudo apt-get install avahi-utils libssl-dev libao-dev libpulse-dev libasound2-dev
cd shairport
make
sudo make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now everything is installed an you have to add the user shairport, edit the config file and make sure Shairport is started during booting [&lt;a href=&quot;http://www.welzels.de/blog/2014/12/raspberry-pi-als-airplay-client-update/&quot;&gt;1&lt;/a&gt;]:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo adduser --system --disabled-login --ingroup audio shairport
sudo nano /etc/default/shairport
sudo update-rc.d shairport defaults
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that the AP_NAME only allows names without any blank spaces. I didn’t like that, so I modified the file &lt;code&gt;/etc/init.d/shairport&lt;/code&gt;. The general problem with this file is that the options string for executing shairport in recursively created, wich makes it really hard to escape any blanks or special characters. A quick workaround is to comment out the part where AP_NAME is added to the options sting and rather add is directly using the parameter&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;-name $AP_NAME
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;install-hifiberry&quot;&gt;Install HifiBerry&lt;/h2&gt;

&lt;p&gt;There is a tutorial available on the &lt;a href=&quot;https://www.hifiberry.com/guides/configuring-linux-3-18-x/&quot;&gt;HifiBerry homepage&lt;/a&gt;. With the newest Rasbian distribution the setup, was however slightly different.&lt;/p&gt;

&lt;p&gt;First you wanna disable the internal sound card by blacklisting the sound card driver, so edit &lt;code&gt;/etc/modprobe.d/raspi-blacklist.conf&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;blacklist snd_bcm2835
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;then you need to change the dtoverlay value in the &lt;code&gt;/boot/config.txt&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dtoverlay=hifiberry-dacplus
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and create the &lt;code&gt;/etc/asound.conf&lt;/code&gt;file&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;pcm.!default  {
 type hw card 0
}
ctl.!default {
 type hw card 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This should do the trick and load your HifiBerry sound card during startup.&lt;/p&gt;

&lt;h2 id=&quot;make-the-disk-read-only&quot;&gt;Make the disk read only&lt;/h2&gt;

&lt;p&gt;The last part is itself not so difficult but may result in strange behavior during startup. I had the problem that during startup my Raspi was stopping von 1,5 minutes or didn’t give the wlan0 any IPv4 address. If you run in problems like this you might want to try to remove the dhcpcd package and install connman. I also had to manually trigger the IPv4 DHCP request by adding &lt;code&gt;dhclient -4 wlan0&lt;/code&gt; to &lt;code&gt;/etc/rc.local&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;In any case you want the folders with temporary data as tmpfs mounted file systems and your /boot and / as readonly. This results in the following &lt;code&gt;/etc/fstab&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;proc			/proc		proc    defaults     0       0
/dev/mmcblk0p1		/boot		vfat    defaults,ro  0       2
/dev/mmcblk0p2		/		ext4    defaults,ro  0       1
tmpfs			/tmp		tmpfs   defaults     0       0
tmpfs			/var/lib/dhcp	tmpfs   defaults     0       0
tmpfs			/var/run	tmpfs   defaults     0       0
tmpfs			/var/lock	tmpfs   defaults     0       0
tmpfs			/var/spool	tmpfs   defaults     0       0
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;test-it&quot;&gt;Test it&lt;/h2&gt;

&lt;p&gt;Now your Airplay Server should work and you are ready to test it. If there is a problem with the setup you can always make the filesystem writeable with the following command:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mount -o remount,rw /
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;reassembling-the-sounddock&quot;&gt;Reassembling the SoundDock&lt;/h1&gt;

&lt;p&gt;When everything works fine you can start to reassemble the housing. I used a wire cutter to remove the plastic parts on the bottom of the housing and my Raspi A+ fits in perfectly. I then attached the Pi with the USB-cable and the step-down converter to the power source that supposed to be charging the batterie, and drilled a hole for the aux cabe. With a bit of try and error I fit everything back in the housing, was able to close the lid and when re-attaching it to the box everything worked like a charm.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://www.alenk.de/assets/final_open.jpg&quot; alt=&quot;This is how it should look like&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And some more pics:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://www.alenk.de/assets/final.jpg&quot; alt=&quot;This is how it should look like&quot; /&gt;&lt;/p&gt;

</description>
        <pubDate>Sun, 17 Jan 2016 09:52:48 +0100</pubDate>
        <link>http://www.alenk.de//2016/BoseAirPlay/</link>
        <guid isPermaLink="true">http://www.alenk.de//2016/BoseAirPlay/</guid>
        
        
        <category>raspi</category>
        
      </item>
    
  </channel>
</rss>
